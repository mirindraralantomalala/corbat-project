<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Devis ‚Äî COR'BAT</title>
  <link rel="stylesheet" href="../css/style.css"/>
  <link rel="icon" type="image/png" href="../favicon.png">
  <style>
    :root {
      --accent1:#ffb400;
      --accent2:#ff6b6b;
      --bg-dark:#000000;
      --card-bg:#000000;
      --text:#000000;
      --muted:#bfc7d1;
      --radius:12px;
      font-family:'Poppins',sans-serif;
    }
    body {
      margin:0; padding:0;
      background:#ffffff;
      color:var(--text);
      overflow-x:hidden;
    }
    /* Desktop */
    .nav {
      display: flex;
    }
    /* ===== HEADER ===== */
    .topbar {
      display: flex;
      align-items: center;
      gap: 24px;
      padding: 18px 40px;
      background: #000;
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 5px 25px rgba(0,0,0,0.1);
      font-family: 'Poppins', sans-serif;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      font-size: 1.2rem;
    }
    .brand .logo img {
      width: 48px;
      height: auto;
      display: inline-block;
      vertical-align: middle;
    }
    .brand .brand-name {
      font-size: 1.4rem;
      letter-spacing: 0.5px;
      background: #ffffff;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .brand img { width:50px; height:auto; }
    .desktop-nav {
      display: flex;
      gap: 28px;
      margin-left: auto;
      align-items: center;
    }
    .nav-link {
      color:#fff;
      text-decoration:none;
      position:relative;
      transition:color .3s;
      font-weight:500;
    }
    .nav-link::after {
      content:"";
      position:absolute;
      bottom:-5px;
      left:0;
      width:0%;
      height:2px;
      background:linear-gradient(90deg,var(--accent1),var(--accent2));
      transition:width .3s;
    }
    .nav-link:hover {
      color:var(--accent1);
    }
    .nav-link:hover::after {
      width:100%;
    }
    .btn-logout {
      background:linear-gradient(90deg,var(--accent1),var(--accent2));
      color:#111;
      font-weight:700;
      padding:8px 14px;
      border:0;
      border-radius:8px;
      cursor:pointer;
      box-shadow:0 4px 10px rgba(255,107,107,0.3);
      transition:transform .2s;
    }
    /* ===== MAIN ===== */
    .container {
      max-width:1200px;
      margin:40px auto;
    }
    h1 {
      background: #000000;
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      font-size:1.8rem;
      margin-bottom:20px;
      text-align:center;
      animation: fadeIn 0.8s ease;
    }
    .card {
      background:var(--card-bg);
      border-radius:var(--radius);
      padding:20px;
      box-shadow:0 8px 30px rgba(0,0,0,0.4);
      border:1px solid rgba(255,255,255,0.05);
      animation: fadeInUp 0.8s ease;
    }
    .toolbar {
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      margin-bottom:16px;
    }
    .search, .filter, .btn {
      padding:10px 12px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.08);
      background:#ffffff;
      color:#000000;
      font-size:0.95rem;
    }
    .btn {
      cursor:pointer;
      font-weight:600;
      transition:background .3s,transform .2s;
    }
    .btn-primary {
      background:linear-gradient(90deg,var(--accent1),var(--accent2));
      color:#111;
    }
    .btn-ghost:hover {
      background:rgba(255,255,255,0.1);
      transform:translateY(-1px);
    }
    .btn-ex {
      background:rgb(0, 225, 255);
      color:#000000;
    }
    table {
      width:100%;
      border-collapse:collapse;
      font-size:0.95rem;
      color:#ddd;
      animation: fadeIn 0.8s ease;
    }
    thead th {
      text-align:left;
      padding:12px;
      background:rgba(255,255,255,0.05);
      border-bottom:1px solid rgba(255,255,255,0.08);
    }

    tbody td {
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,0.03);
      transition: background 0.3s, box-shadow 0.3s;
    }
    /* ‚ú® Survol lumineux des lignes */
    tbody tr:hover {
      background:rgba(255,255,255,0.05);
      box-shadow:0 0 8px rgba(255,180,0,0.3);
      transform:scale(1.01);
      transition: all 0.25s ease;
    }
    .status {
      padding:5px 10px;
      border-radius:8px;
      font-weight:700;
      font-size:0.85rem;
      text-transform:capitalize;
    }
    .status.nouvelle { background:rgba(255,180,0,0.15); color:var(--accent1); }
    .status.contact√©e { background:rgba(20,184,166,0.15); color:#10b981; }
    .status.r√©solue { background:rgba(239,68,68,0.15); color:#ef4444; }
    .actions button {
      border:0;
      border-radius:8px;
      padding:6px 8px;
      cursor:pointer;
      font-weight:700;
      margin-right:6px;
    }
    .actions .pdf {
      background:rgba(255,255,255,0.1);
      color:#fff;
    }
    .actions .danger {
      background:red;
      color:#ffffff;
    }
    /* ‚ú® Animation fade-in */
    @keyframes fadeIn {
      from { opacity:0; transform:translateY(10px); }
      to { opacity:1; transform:translateY(0); }
    }
    @keyframes fadeInUp {
      from { opacity:0; transform:translateY(30px); }
      to { opacity:1; transform:translateY(0); }
    }
        /* ===== Mobile menu admin ===== */
        .menu-toggle {
      background: none;
      border: none;
      font-size: 1.8rem;
      color: #fff;
      cursor: pointer;
      display: none;
    }

    .mobile-menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      opacity: 0;
      pointer-events: none;
      transition: 0.3s ease;
      z-index: 998;
    }

    .mobile-menu-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .mobile-nav {
      position: fixed;
      top: 0;
      right: -100%;
      width: 85%;
      max-width: 340px;
      height: 100vh;
      background: #000;
      display: flex;
      flex-direction: column;
      padding: 24px;
      gap: 8px;
      transition: 0.35s ease;
      z-index: 999;
    }

    .mobile-nav.active {
      right: 0;
    }

    .close-menu {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.5rem;
      align-self: flex-end;
      cursor: pointer;
    }

    .mobile-nav .nav-link {
      font-size: 1.05rem;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }

    .admin-actions-mobile {
      margin-top: auto;
      display: flex;
      flex-direction: column;
    }

    @media (max-width: 900px) {
      .desktop-nav {
        display: none;
      }

      .menu-toggle {
        display: block;
      }
    }

    h1 {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 18px;
    }

    /* Mobile */
    @media (max-width: 768px) {
      h1 {
        font-size: 1.3rem;
        margin-bottom: 14px;
      }
    }
  </style>
</head>

<body>
  <!-- ===== HEADER ===== -->
  <header class="topbar">
    <div class="brand">
      <span class="logo">
        <img src="../images/COR'BAT.png" alt="COR'BAT">
      </span>
      <span class="brand-name">Admin COR'BAT</span>
    </div>
  
    <!-- Desktop menu -->
    <nav class="nav desktop-nav">
      <a href="dashboard.html" class="nav-link">Tableau de bord</a>
      <a href="devis.html" class="nav-link">Liste devis</a>
      <a href="leads.html" class="nav-link">Clients int√©ress√©s</a>
      <a href="projects.html" class="nav-link">Projets r√©cents</a>
      <a href="services.html" class="nav-link">Nos services</a>
      <a href="callbacks.html" class="nav-link">Demandes de rappel</a>
  
      <button id="btnLogout" class="btn-logout">Se d√©connecter</button>
    </nav>
  
    <!-- Bouton mobile -->
    <button class="menu-toggle" id="menuToggle" aria-label="Ouvrir le menu">‚ò∞</button>
  
    <!-- Overlay -->
    <div class="mobile-menu-overlay" id="mobileOverlay"></div>
  
    <!-- Mobile menu -->
    <nav class="mobile-nav" id="mobileMenu">
      <button class="close-menu" id="closeMenu">‚úï</button>
  
      <a href="dashboard.html" class="nav-link">Tableau de bord</a>
      <a href="devis.html" class="nav-link">Liste devis</a>
      <a href="leads.html" class="nav-link">Clients int√©ress√©s</a>
      <a href="projects.html" class="nav-link">Projets r√©cents</a>
      <a href="services.html" class="nav-link">Nos services</a>
      <a href="callbacks.html" class="nav-link">Demandes de rappel</a>
  
      <div class="admin-actions-mobile">
        <button id="btnLogoutMobile" class="btn-logout">Se d√©connecter</button>
      </div>
    </nav>
  </header>
  <!-- ===== MAIN CONTENT ===== -->
  <main class="container">
    <h1>Liste des demandes de devis</h1>
    <div class="card">
      <div class="toolbar">
        <input id="q" class="search" placeholder="üîç Rechercher..." />
        <div class="filter-wrapper">
          <label for="filterStatus" class="filter-label">Filtrer par statut :</label>
          <select id="filterStatus" class="filter enhanced-select">
            <option value="" class="value">Tous les statuts</option>
            <option value="nouvelle" class="value">Nouvelle</option>
            <option value="contact√©e" class="value">Contact√©e</option>
            <option value="r√©solue" class="value">R√©solue</option>
          </select>
        </div>              
        <button id="exportCsv" class="btn btn-ex">Exporter CSV</button>
        <button id="refreshBtn" class="btn btn-ex">Actualiser</button>
      </div>

      <div style="overflow:auto; max-height:64vh;">
        <table>
          <thead>
            <tr>
              <th>Nom</th><th>T√©l√©phone</th><th>Service</th>
              <th>Email</th><th>Adresse</th><th>Surface</th><th>Date</th><th>Statut</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="devisTable">
            <tr><td colspan="10" style="text-align:center;padding:20px;">Chargement...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>
  <!-- ========== Admin Footer ========== -->
  <footer class="admin-footer" role="contentinfo" aria-label="Pied de page administration">
    <div class="admin-footer-inner">
      <div class="admin-left">
        <div class="admin-brand">
          <img src="../images/COR'BAT.png" alt="COR'BAT" />
          <div>
            <strong>Admin COR'BAT</strong>
            <div class="small muted">Espace administrateur</div>
          </div>
        </div>
        
      </div>
  
      <div class="admin-right">
        <nav class="admin-links" aria-label="Liens utilitaires admin">
          <a href="dashboard.html" class="nav-link">Tableau de bord</a>
          <a href="devis.html" class="nav-link">Devis</a>
          <a href="leads.html" class="nav-link">Clients</a>
          <a href="projects.html" class="nav-link">Projets</a>
          <a href="services.html" class="nav-link">Services</a>
          <a href="callbacks.html" class="nav-link">Demande de rappel</a>
        </nav>
      </div>
    </div>
  
    <div class="admin-footer-bottom">
      <small>¬© <span id="adminYear"></span> COR'BAT ‚Äî Espace Admin ‚Ä¢ Tous droits r√©serv√©s.</small>
    </div>
  </footer>
  <!-- ====== Styles pour admin-footer ====== -->
  <style>
    .admin-footer {
      background:#070707;
      color:#e6e6e6;
      padding:18px 24px;
      border-top:1px solid rgba(255,255,255,0.04);
      font-family: 'Poppins', sans-serif;
      margin-top:32px;
    }
    .admin-footer-inner {
      display:flex;
      gap:20px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .admin-left { display:flex; gap:14px; align-items:center; min-width:200px; }
    .admin-brand img { width:44px; height:44px; object-fit:contain; border-radius:8px; }
    .admin-brand strong { display:block; color:#fff; }
    .small { font-size:0.87rem; }
    .muted { color:#a9a9a9; }
    .admin-center { flex:1; display:flex; justify-content:center; }
    .kpis { display:flex; gap:22px; align-items:center; }
    .kpi { text-align:center; min-width:88px; }
    .kpi-value { font-weight:700; font-size:1.25rem; color:linear-gradient(90deg,#ffb400,#ff6b6b); }
    .kpi-label { font-size:0.85rem; color:#bdbdbd; }
    .admin-right { display:flex; gap:14px; align-items:center; min-width:220px; justify-content:flex-end; }
    .admin-links { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .admin-links a { color:#dfe6ef; text-decoration:none; font-size:0.95rem; padding:6px 8px; border-radius:6px; }
    .admin-links a:hover { background:rgba(255,255,255,0.02); color:#fff; }
    .admin-actions { display:flex; gap:8px; align-items:center; }
    .btn-ghost.small { padding:6px 10px; background:transparent; color:#ccc; border:1px solid rgba(255,255,255,0.03); border-radius:8px; cursor:pointer; }
    .btn-logout { background:#ef4444; color:#ffffff; padding:8px 12px; border-radius:8px; border:0; cursor:pointer; font-weight:700; }
    .admin-footer-bottom { text-align:center; margin-top:12px; color:#9a9a9a; font-size:0.88rem; border-top:1px solid rgba(255,255,255,0.02); padding-top:10px; }
    .dev-credit {
      position: fixed;
      bottom: 10px;
      right: 14px;
      font-size: 0.68rem;
      opacity: 0.25;
      color: #ffffff; /* si fond clair ‚Üí change en #555 */
      line-height: 1.25;
      text-align: right;
      transition: opacity 0.25s ease, transform 0.25s ease;
      z-index: 9999;
    }
    .dev-credit a {
      color: inherit;
      text-decoration: none;
    }
    .dev-credit:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
/* =================== MOBILE =================== */
@media (max-width: 768px) {
  .admin-footer {
    padding: 18px 14px 22px;
  }

  .admin-footer-inner {
    flex-direction: column;
    align-items: stretch;
    gap: 16px;
  }

  .admin-left {
    flex-direction: column;
    gap: 10px;
  }

  .admin-right {
    justify-content: flex-start;
  }

  .admin-links {
    flex-direction: column;
    align-items: stretch;
  }

  .admin-links a {
    width: 100%;
    text-align: left;
    padding: 12px 14px;
    font-size: 1rem;
  }

  .admin-footer-bottom {
    font-size: 0.8rem;
  }

  .dev-credit {
    text-align: left;
    font-size: 0.75rem;
    opacity: 0.7;
  }
}
  </style>
  <!-- ===== SCRIPT ===== -->
  <script>
    const API_URL = "/api/quotes";

    document.getElementById("adminYear").textContent = new Date().getFullYear();

      // D√©connexion via backend (efface cookie)
      const btnLogout = document.getElementById('btnLogout');
      const btnLogoutMobile = document.getElementById('btnLogoutMobile');

      async function logout() {
        if(!confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) return;

        await fetch("/api/auth/logout", {
          method: "POST",
          credentials: "include"
        });

        localStorage.removeItem('btp_admin_logged');
        localStorage.removeItem('btp_admin_token');
        sessionStorage.removeItem('btp_admin_logged');
        sessionStorage.removeItem('btp_admin_token');

        window.location.href = "login.html";
      }

      if (btnLogout) {
        btnLogout.addEventListener('click', logout);
      }

      if (btnLogoutMobile) {
        btnLogoutMobile.addEventListener('click', logout);
      }
        
    (async function () {
      const tableBody = document.getElementById("devisTable");
      const q = document.getElementById("q");
      const filterStatus = document.getElementById("filterStatus");
    
      // === üîπ R√©cup√©ration des devis ===
      async function fetchQuotes() {
        try {
          const res = await fetch(API_URL);
          if (!res.ok) throw new Error("‚ùå Erreur serveur");
          return await res.json();
        } catch (err) {
          console.error(err);
          alert("‚ùå Erreur de connexion au serveur.");
          return [];
        }
      }
    
      function fmt(d) {
        try {
          return new Date(d).toLocaleString("fr-FR");
        } catch (e) {
          return d;
        }
      }
      function safe(v) {
        return v || "-";
      }
    
      // === üîπ Rendu du tableau ===
      async function render() {
        const quotes = await fetchQuotes();
        let rows = quotes;
        const search = q.value.toLowerCase().trim();
        const statusF = filterStatus.value.toLowerCase().trim();
    
        if (statusF)
          rows = rows.filter((r) => (r.status || "").toLowerCase() === statusF);
        if (search)
          rows = rows.filter((r) =>
            ((r.fullname || "") + (r.email || "") + (r.service || ""))
              .toLowerCase()
              .includes(search)
          );
    
        if (rows.length === 0) {
          tableBody.innerHTML =
            '<tr><td colspan="10" style="text-align:center;padding:20px;">Aucun devis trouv√©.</td></tr>';
          return;
        }
    
        tableBody.innerHTML = rows
          .map(
            (r) => `
          <tr style="animation:fadeIn 0.6s ease;">
            <td>${safe(r.fullname)}</td>
            <td>${safe(r.phone)}</td>
            <td>${safe(r.service)}</td>
            <td>${safe(r.email)}</td>
            <td>${safe(r.address)}</td>
            <td>${safe(r.surface)} m¬≤</td>
            <td>${fmt(r.created_at)}</td>
            <td>
              <select class="status-select" data-id="${r.id}">
                <option value="nouvelle" ${r.status === "nouvelle" ? "selected" : ""}>Nouvelle</option>
                <option value="contact√©e" ${r.status === "contact√©e" ? "selected" : ""}>Contact√©e</option>
                <option value="r√©solue" ${r.status === "r√©solue" ? "selected" : ""}>R√©solue</option>
              </select>
            </td>
            <td class="actions">
              <button class="danger" data-id="${r.id}">Supprimer</button>
            </td>
          </tr>`
          )
          .join("");
    
        // === ‚öôÔ∏è Changement de statut ===
        tableBody.querySelectorAll(".status-select").forEach((select) => {
          select.addEventListener("change", async (e) => {
            const id = e.target.dataset.id;
            const newStatus = e.target.value;
            e.target.disabled = true;
    
            try {
              const res = await fetch(`${API_URL}/${id}/status`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ status: newStatus }),
              });
    
              const data = await res.json().catch(() => ({}));
    
              if (!res.ok) {
                const msg = data.error || `‚ùå Erreur serveur (${res.status})`;
                throw new Error(msg);
              }
    
              console.log(`‚úÖ Statut du devis ${id} mis √† jour en ${newStatus}`);
              e.target.style.backgroundColor =
                newStatus === "nouvelle"
                  ? "rgba(255,180,0,0.15)"
                  : newStatus === "contact√©e"
                  ? "rgba(20,184,166,0.15)"
                  : "rgba(239,68,68,0.15)";
            } catch (err) {
              console.error(err);
              alert("‚ùå Erreur lors de la mise √† jour du statut : " + err.message);
            } finally {
              e.target.disabled = false;
            }
          });
        });
    
        // === üóëÔ∏è Bouton Supprimer ===
        tableBody.querySelectorAll(".danger").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const id = e.currentTarget.dataset.id;
            if (!confirm("Voulez-vous vraiment supprimer ce devis ?")) return;
            try {
              const res = await fetch(`${API_URL}/${id}`, { method: "DELETE" });
              if (!res.ok) throw new Error("‚ùåErreur suppression");
              alert("‚úÖ Devis supprim√© avec succ√®s !");
              await render();
            } catch (err) {
              console.error(err);
              alert("‚ùå Erreur lors de la suppression du devis.");
            }
          });
        });
      }
    
      // === üîπ Boutons & filtres ===
      document.getElementById("refreshBtn").addEventListener("click", render);
      q.addEventListener("input", render);
      filterStatus.addEventListener("change", render);
    
      document.getElementById("exportCsv").addEventListener("click", async () => {
        const quotes = await fetchQuotes();
        if (!quotes.length) return alert("Aucun devis √† exporter.");
        const header = Object.keys(quotes[0]);
        const csv = [
          header.join(","),
          ...quotes.map((q) =>
            header
              .map((h) => `"${(q[h] || "").toString().replace(/"/g, '""')}"`)
              .join(",")
          ),
        ].join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "Devis.csv";
        a.click();
        URL.revokeObjectURL(url);
      });
    
      // Premier affichage
      render();
    })();
  </script>
  <script>
    const menuToggle = document.getElementById("menuToggle");
    const mobileMenu = document.getElementById("mobileMenu");
    const closeMenu = document.getElementById("closeMenu");
    const overlay = document.getElementById("mobileOverlay");
    
    menuToggle.addEventListener("click", () => {
      mobileMenu.classList.add("active");
      overlay.classList.add("active");
    });
    
    closeMenu.addEventListener("click", closeMobileMenu);
    overlay.addEventListener("click", closeMobileMenu);
    
    function closeMobileMenu() {
      mobileMenu.classList.remove("active");
      overlay.classList.remove("active");
    }
    </script>
</body>
</html>
